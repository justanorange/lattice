# Lattice - Лог изменений

Документ отслеживает все исправления и улучшения, внесённые в проект на основе тестирования и обратной связи.

## Раунд 2: UX и реализация стратегий (10.12.2025)

### Исправления

#### 1. Risk Strategy → Win Probability Strategy ✅

**Проблема**: Стратегия "Контролируемый риск" интерпретировалась неправильно.

**Изменение**:
- **Старое название**: "Контролируемый риск" (параметр `riskLevel`)
- **Новое название**: "Целевая вероятность выигрыша" (параметр `winProbability`)

**Формула расчёта**:
```
Старая (НЕПРАВИЛЬНАЯ):
safetyFactor = ln(100 - risk + 1) / ln(100)
coverage = safetyFactor * 90

Новая (ПРАВИЛЬНАЯ):
n = log(1 - P_win) / log(1 - p)
Где:
  n = количество необходимых билетов
  P_win = целевая вероятность выигрыша (от 0.01 до 0.99)
  p = вероятность выигрыша в одном билете (зависит от лотереи)
```

**Интерпретация**:
- Пользователь задаёт желаемую вероятность выигрыша хотя бы в одном билете (1-99%)
- Система рассчитывает, сколько билетов нужно купить для достижения этой вероятности
- Пример: 50% вероятность выигрыша требует примерно 349,264 билета в лотерее 8+1

**Файлы**: `src/entities/strategies/config.ts`

---

#### 2. Удаление дефолтных значений из текстовых полей ✅

**Проблема**: Поля `wheelnumbers` и `keyNumbers` имели дефолтные значения, и при удалении всех чисел поле восстанавливалось в дефолт.

**Изменение**:
- **Было**: `defaultValue: '1 2 3 4 5 6 7 8 9 10'` для wheel, `'1 2 3 4'` для key
- **Стало**: `defaultValue: ''` (пустое значение)

**Поведение**:
- При удалении всех чисел поле остаётся пустым
- Пустое поле → расчёт возвращает 0 билетов (указывает на ошибку)
- Система не позволяет пользователю случайно использовать неправильные числа

**Файлы**: 
- `src/entities/strategies/config.ts` (определение стратегий)
- `src/features/strategy-selection/StrategySelectionPage.tsx` (логика инициализации)

---

#### 3. Обработка пустых полей в расчётах ✅

**Проблема**: Когда пользователь очищает поле `wheelnumbers` или `keyNumbers`, система всё равно пыталась генерировать билеты.

**Изменение**:
```typescript
// Было (неправильно):
if (numbers.length === 0) return 1;

// Стало (правильно):
if (numbers.length === 0) return 0; // Can't generate wheel without numbers
```

**Для Full Wheel**:
- Пустое поле → 0 билетов
- Недостаточно чисел → 0 билетов
- Достаточно чисел → C(n, k) билетов

**Для Key Wheel**:
- Пустое поле ключевых чисел → 0 билетов
- Остальная логика остаётся

**Файлы**: `src/entities/strategies/config.ts`

---

#### 4. Удаление ограничения на 12 билетов в UI ✅

**Проблема**: GenerationPage отображал максимум 12 билетов с сообщением "... и еще N билетов", но их нельзя было увидеть.

**Изменение**:
```typescript
// Было (НЕПРАВИЛЬНО):
{result.tickets.slice(0, 12).map(...)}
{result.tickets.length > 12 && (
  <p className="mt-4 text-xs...">
    ... и еще {result.tickets.length - 12} билетов
  </p>
)}

// Стало (ПРАВИЛЬНО):
{result.tickets.map(...)}
// Все билеты выводятся, нет ограничений
```

**Результаты**:
- Все сгенерированные билеты отображаются в сетке
- Контейнер с полосой прокрутки позволяет просмотреть все билеты
- Нет скрытых билетов

**Файлы**: `src/features/generation/GenerationPage.tsx`

---

### Обновление документации

#### SPEC.md - Раздел "Стратегии" ✅

Добавлен полный раздел с описанием всех 5 реализованных стратегий:

1. **Гарантия минимального выигрыша** (`min_risk`)
   - Параметр: количество выигрышных билетов
   - Формула: `ceil((guaranteed / p) * 1.5)`

2. **Максимальное покрытие** (`max_coverage`)
   - Параметр: % покрытия (1-99%)
   - Экспоненциальная шкала
   - Формула: `tickets = -N * ln(1 - coverage%)`

3. **Полное колесо** (`full_wheel`)
   - Параметр: числа через запятую или пробел
   - Результат: C(n, k) комбинаций
   - Гарантирует выигрыш при совпадении всех выбранных чисел

4. **Колесо с ключевыми числами** (`key_wheel`)
   - Параметр: обязательные числа
   - Ключевые числа в КАЖДОМ билете
   - Остальные позиции заполняются комбинациями

5. **Целевая вероятность выигрыша** (`risk_strategy`)
   - Параметр: вероятность выигрыша (1-99%)
   - Формула: `n = log(1 - P) / log(1 - p)`
   - Рассчитывает количество билетов для целевой вероятности

#### SPEC.md - Раздел "Экран выбора стратегии" ✅

Добавлены детальные описания 4 режимов работы с примерами.

#### SPEC.md - Раздел "Экран результатов генерации" ✅

Обновлены требования:
- Все билеты отображаются (нет ограничений)
- Статистика: количество, стоимость, параметры стратегии
- Интерфейс остаётся отзывчивым при 1000+ билетах

#### SPEC.md - Новая секция "Ограничения на генерацию" ✅

```markdown
- **Нет ограничений на количество билетов** (раньше было максимум 12, удалено)
- Система генерирует ВСЕ запрошенные билеты
- Если есть 1000+ билетов, интерфейс должен оставаться отзывчивым
```

---

### Текущее состояние проекта

**Build Status**: ✅ Clean (0 errors, 1.04s)
```
✓ 1727 modules transformed
dist/assets/index-C1vN8mdm.js: 297.88 kB (gzip 93.25 kB)
dist/assets/index-BHnM_0Ih.css: 31.41 kB (gzip 6.99 kB)
```

**Git Commits**:
```
71d2b15 - fix: correct risk strategy to win probability, remove defaults from wheel inputs, allow unlimited ticket generation
c5e14df - fix: return 0 tickets when required input fields are empty (wheelnumbers, keyNumbers)
```

---

### Детали реализации

#### Валидация параметров текстовых полей

**Регулярное выражение**: `/^[0-9,\s]*$/`

Поддерживает:
- Цифры: 0-9
- Запятые: `,`
- Пробелы: ` ` (в том числе переносы строк)

**Примеры валидных вводов**:
```
5 10 15 20 25 30
5,10,15,20,25,30
5, 10, 15, 20, 25, 30
5
10 20
```

#### Парсинг чисел

```typescript
function parseNumbers(str: string): number[] {
  return str
    .split(/[,\s]+/)              // Разделяет запятой или пробелом
    .map((n) => parseInt(n.trim())) // Преобразует в числа
    .filter((n) => !isNaN(n) && n > 0); // Фильтрует невалидные
}
```

---

### Тестирование

Проведено функциональное тестирование:

1. ✅ Risk Strategy с разными вероятностями
2. ✅ Full Wheel с пустым полем (возвращает 0)
3. ✅ Full Wheel с недостаточным количеством чисел
4. ✅ Key Wheel с пустым полем
5. ✅ Отображение 100+ билетов без срезания
6. ✅ TypeScript compilation без ошибок

---

## Раунд 1: Математические исправления

### Ключевые исправления (предыдущий раунд)
- ✅ Вероятность 5+0=1:14, 4+1=1:15 (подтверждено)
- ✅ Покрытие: линейная ошибка → Coupon Collector Problem
- ✅ Стоимость билета: 100 → 300 ₽
- ✅ Суперприз: 100M → 5M ₽
- ✅ Удаление дефолтной стратегии
- ✅ Валидация текстовых полей

---

## Архитектурные решения

### Структура параметров стратегий

```typescript
interface StrategyParameter {
  key: string;           // Ключ параметра
  label: string;         // Человеческое название
  type: 'number' | 'range' | 'text'; // Тип входа
  defaultValue?: any;    // Дефолт (или undefined для обязательных)
  min?: number;
  max?: number;
  step?: number;
  description: string;   // Подсказка для пользователя
}
```

### Расчёт количества билетов

Все стратегии используют функцию `calculateTicketCountForStrategy()` в `config.ts`:
- Возвращает целое число (количество билетов)
- Может вернуть 0, если параметры невалидны
- Учитывает ограничение максимального количества комбинаций

---

## Future Improvements

### Планируемые улучшения

1. **Виртуализация списка** (для 1000+ билетов)
   - Отображение только видимых элементов
   - Мягкая прокрутка

2. **Валидация вывода** в UI
   - Выделение ошибок красным
   - Подсказки о том, почему расчёт не возможен

3. **Экспорт в PDF**
   - Красивая печать билетов
   - Включение параметров стратегии

4. **Симуляция**
   - Graph ROI
   - Распределение выигрышей

5. **История генераций**
   - Сохранение последних результатов
   - Возможность повторить параметры

---

## Контрольный список для будущих разработчиков

При добавлении новых стратегий убедитесь:

- [ ] Добавлена новая `Strategy` константа в `config.ts`
- [ ] Добавлена запись в `ALL_STRATEGIES` объект
- [ ] Реализована функция генерации в `generator.ts`
- [ ] Добавлен case в `calculateTicketCountForStrategy()`
- [ ] Добавлен case в `executeStrategy()`
- [ ] Написана документация в `SPEC.md`
- [ ] Протестирована с пустыми параметрами
- [ ] Build успешен: `npm run build`
- [ ] Коммит с понятным сообщением

---

**Последнее обновление**: 10.12.2025  
**Статус**: ✅ Ready for testing  
**Build**: ✅ Clean (1.04s, 0 errors)
